name: Build and Push Docker Images (Parallel)

on:
    push:
        branches: [main]
    pull_request:
        types: [closed]
        branches: [main]

env:
    DOCKER_REGISTRY: ${{ secrets.DOCKER_REGISTRY || 'docker.io' }}
    DOCKER_NAMESPACE: ${{ secrets.DOCKER_NAMESPACE || 'formulablu' }}

jobs:
    build-and-push:
        runs-on: ubuntu-latest

        # Only run on push to main or when PR is merged to main
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)

        strategy:
            matrix:
                api: [drivers-api, teams-api, tracks-api, races-api, seasons-api, events-api, results-api, api-gateway]

        steps:
            - name: Validate required secrets
              run: |
                  if [ -z "${{ secrets.DOCKERHUB_USERNAME }}" ]; then
                      echo "âŒ DOCKERHUB_USERNAME secret is required but not set"
                      exit 1
                  fi
                  if [ -z "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
                      echo "âŒ DOCKERHUB_TOKEN secret is required but not set"
                      exit 1
                  fi
                  echo "âœ… All required secrets are available"

            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  submodules: recursive
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  java-version: "21"
                  distribution: "temurin"

            - name: Cache Gradle packages
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.gradle/caches
                      ~/.gradle/wrapper
                  key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
                  restore-keys: |
                      ${{ runner.os }}-gradle-

            - name: Make gradlew executable
              run: chmod +x formulaBlu/gradlew

            - name: Build specific API
              run: |
                  cd formulaBlu
                  ./gradlew :${{ matrix.api }}:bootJar --no-daemon

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to Docker Hub
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.DOCKER_REGISTRY }}
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Build and push ${{ matrix.api }}
              uses: docker/build-push-action@v5
              with:
                  context: ./formulaBlu
                  file: ./formulaBlu/${{ matrix.api }}/Dockerfile
                  push: true
                  tags: |
                      ${{ env.DOCKER_NAMESPACE }}/${{ matrix.api }}:latest
                      ${{ env.DOCKER_NAMESPACE }}/${{ matrix.api }}:${{ github.sha }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
                  platforms: linux/amd64

    update-deployments:
        runs-on: ubuntu-latest
        needs: build-and-push
        if: always() && (needs.build-and-push.result == 'success')

        steps:
            - name: Checkout deployment repo
              uses: actions/checkout@v4
              with:
                  repository: ${{ github.repository_owner }}/FormulaBlu-Deployments
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Update deployment manifests
              run: |
                  # Update each API deployment with the new image tag
                  for api in drivers-api teams-api tracks-api races-api seasons-api events-api results-api api-gateway; do
                    if [ -f "modules/$api/${api}-deployment.yaml" ]; then
                      sed -i "s|image: formulablu/$api:.*|image: formulablu/$api:${{ github.sha }}|g" "modules/$api/${api}-deployment.yaml"
                      echo "Updated $api deployment with image tag: ${{ github.sha }}"
                    fi
                  done

                  # Commit and push changes to deployment repo
                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action"
                  git add .
                  git diff --staged --quiet || git commit -m "Update image tags to ${{ github.sha }} [skip ci]"
                  git push origin main || echo "No changes to commit or push failed"

            - name: Summary
              run: |
                  echo "## ðŸ³ Docker Images Built and Pushed Successfully!" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Images pushed to Docker Hub:" >> $GITHUB_STEP_SUMMARY
                  echo "- formulablu/drivers-api:latest" >> $GITHUB_STEP_SUMMARY
                  echo "- formulablu/teams-api:latest" >> $GITHUB_STEP_SUMMARY
                  echo "- formulablu/tracks-api:latest" >> $GITHUB_STEP_SUMMARY
                  echo "- formulablu/races-api:latest" >> $GITHUB_STEP_SUMMARY
                  echo "- formulablu/seasons-api:latest" >> $GITHUB_STEP_SUMMARY
                  echo "- formulablu/events-api:latest" >> $GITHUB_STEP_SUMMARY
                  echo "- formulablu/results-api:latest" >> $GITHUB_STEP_SUMMARY
                  echo "- formulablu/api-gateway:latest" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Image tags:" >> $GITHUB_STEP_SUMMARY
                  echo "- Latest: \`latest\`" >> $GITHUB_STEP_SUMMARY
                  echo "- Commit-specific: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Next steps:" >> $GITHUB_STEP_SUMMARY
                  echo "1. Deploy to Kubernetes using the updated manifests" >> $GITHUB_STEP_SUMMARY
                  echo "2. Verify all services are running correctly" >> $GITHUB_STEP_SUMMARY
                  echo "3. Run health checks on all endpoints" >> $GITHUB_STEP_SUMMARY
