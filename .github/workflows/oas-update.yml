name: OAS Update and Rebuild

on:
    push:
        branches: [main]
        paths:
            - "OAS/**"
            - ".gitmodules"
    workflow_dispatch:

env:
    DOCKER_REGISTRY: ${{ secrets.DOCKER_REGISTRY || 'docker.io' }}
    DOCKER_NAMESPACE: ${{ secrets.DOCKER_NAMESPACE || 'formulablu' }}

jobs:
    oas-update:
        runs-on: ubuntu-latest

        steps:
            - name: Validate required secrets
              run: |
                  if [ -z "${{ secrets.DOCKERHUB_USERNAME }}" ]; then
                      echo "âŒ DOCKERHUB_USERNAME secret is required but not set"
                      exit 1
                  fi
                  if [ -z "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
                      echo "âŒ DOCKERHUB_TOKEN secret is required but not set"
                      exit 1
                  fi
                  echo "âœ… All required secrets are available"

            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  submodules: recursive
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  java-version: "21"
                  distribution: "temurin"

            - name: Cache Gradle packages
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.gradle/caches
                      ~/.gradle/wrapper
                  key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
                  restore-keys: |
                      ${{ runner.os }}-gradle-

            - name: Make gradlew executable
              run: chmod +x formulaBlu/gradlew

            - name: Update OAS submodule
              run: |
                  cd formulaBlu
                  git submodule update --remote --merge
                  git add OAS
                  git diff --staged --quiet || git commit -m "Update OAS submodule [skip ci]"
                  git push origin main || echo "No OAS changes to commit"

            - name: Generate models from OAS
              run: |
                  cd formulaBlu
                  ./gradlew openApiGenerate --no-daemon

            - name: Build all APIs with OAS models
              run: |
                  cd formulaBlu
                  ./gradlew build --no-daemon

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to Docker Hub
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.DOCKER_REGISTRY }}
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Build and push all images
              run: |
                  cd formulaBlu
                  for api in drivers-api teams-api tracks-api races-api seasons-api events-api results-api api-gateway; do
                    echo "Building and pushing $api..."
                    docker build -t ${{ env.DOCKER_NAMESPACE }}/$api:latest -t ${{ env.DOCKER_NAMESPACE }}/$api:${{ github.sha }} -f $api/Dockerfile .
                    docker push ${{ env.DOCKER_NAMESPACE }}/$api:latest
                    docker push ${{ env.DOCKER_NAMESPACE }}/$api:${{ github.sha }}
                  done

            - name: Summary
              run: |
                  echo "## ðŸ”„ OAS Update and Rebuild Complete!" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### What was updated:" >> $GITHUB_STEP_SUMMARY
                  echo "- OAS submodule updated to latest" >> $GITHUB_STEP_SUMMARY
                  echo "- Java models regenerated from OAS specifications" >> $GITHUB_STEP_SUMMARY
                  echo "- All APIs rebuilt with updated models" >> $GITHUB_STEP_SUMMARY
                  echo "- All Docker images rebuilt and pushed" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Images updated:" >> $GITHUB_STEP_SUMMARY
                  echo "- formulablu/drivers-api:latest" >> $GITHUB_STEP_SUMMARY
                  echo "- formulablu/teams-api:latest" >> $GITHUB_STEP_SUMMARY
                  echo "- formulablu/tracks-api:latest" >> $GITHUB_STEP_SUMMARY
                  echo "- formulablu/races-api:latest" >> $GITHUB_STEP_SUMMARY
                  echo "- formulablu/seasons-api:latest" >> $GITHUB_STEP_SUMMARY
                  echo "- formulablu/events-api:latest" >> $GITHUB_STEP_SUMMARY
                  echo "- formulablu/results-api:latest" >> $GITHUB_STEP_SUMMARY
                  echo "- formulablu/api-gateway:latest" >> $GITHUB_STEP_SUMMARY
